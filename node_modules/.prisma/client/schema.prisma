generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////
/// ENUMS
////////////////////

enum RoleName {
  CLIENT
  ADMIN
  RISK
  SUPPORT
  BROKER
}

enum UserStatus {
  UNVERIFIED
  MIFID_PENDING
  KYC_PENDING
  ACTIVE
  SUSPENDED
}

enum AccountType {
  DEMO
  REAL
}

enum AccountStatus {
  INACTIVE
  ACTIVE
  BLOCKED
}

enum TradeType {
  BUY
  SELL
}

enum TradeStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
}

enum WithdrawalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LedgerType {
  DEPOSIT
  WITHDRAWAL
  TRADE_PNL
  COMMISSION
  ADJUSTMENT
}

enum KYCStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RiskClass {
  LOW
  MEDIUM
  HIGH
}

enum PositionMode {
  HEDGE
  ONE_WAY
}

enum FundType {
  CLIENT
  BROKER
  AFFILIATE
}

enum RiskEventType {
  LIQUIDATION_WARNING
  LIQUIDATION_EXECUTED
  MARGIN_CALL
  TRADE_LIMIT_EXCEEDED
}

enum CommissionType {
  STANDARD
  AFFILIATE
  REBATE
}

////////////////////
/// USER
////////////////////

model User {
  id       String     @id @default(cuid())
  email    String     @unique
  password String
  name     String?
  role     RoleName   @default(CLIENT)
  status   UserStatus @default(UNVERIFIED)

  mifid    MiFIDProfile?
  kyc      UserKYC?
  accounts Account[]
  audits   AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

////////////////////
/// ACCOUNT & WALLET
////////////////////

model Account {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  type     AccountType
  status   AccountStatus @default(INACTIVE)
  currency String
  leverage Int

  wallet Wallet?
  trades Trade[]

  createdAt DateTime @default(now())
}

model Wallet {
  id        String  @id @default(cuid())
  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id])

  balance    Decimal @default(0)
  available  Decimal @default(0)
  marginUsed Decimal @default(0)
  equity     Decimal @default(0)
  freeMargin Decimal @default(0)

  ledger      LedgerEntry[]
  deposits    Deposit[]
  withdrawals Withdrawal[]
}

////////////////////
/// TRADING
////////////////////

model Trade {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id])

  marketId String?
  market   Market? @relation(fields: [marketId], references: [id])

  symbol String
  type   TradeType
  status TradeStatus @default(OPEN)

  volume     Decimal
  price      Decimal
  entryPrice Decimal?
  exitPrice  Decimal?
  pnl        Decimal  @default(0)

  openedAt DateTime  @default(now())
  closedAt DateTime?

  createdAt DateTime @default(now())
}

////////////////////
/// LEDGER
////////////////////

model LedgerEntry {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  type      LedgerType
  amount    Decimal
  reference String?

  createdAt DateTime @default(now())
}

////////////////////
/// DEPOSITS / WITHDRAWALS
////////////////////

model Deposit {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  amount Decimal
  method String
  status DepositStatus @default(PENDING)

  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
}

model Withdrawal {
  id       String @id @default(cuid())
  walletId String
  wallet   Wallet @relation(fields: [walletId], references: [id])

  amount Decimal
  status WithdrawalStatus @default(PENDING)

  approvedBy String?
  approvedAt DateTime?

  createdAt DateTime @default(now())
}

////////////////////
/// MIFID & KYC
////////////////////

model MiFIDProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  experience String
  objectives String
  riskClass  RiskClass
  eligible   Boolean   @default(false)

  createdAt DateTime @default(now())
}

model UserKYC {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id])

  documentId String
  status     KYCStatus @default(PENDING)

  reviewedAt DateTime?
}

////////////////////
/// MARKETS
////////////////////

model Market {
  id     String  @id @default(cuid())
  symbol String  @unique
  name   String?
  type   String? // 'FOREX', 'CRYPTO', 'COMMODITY', 'INDEX'

  spread    Float @default(0)
  swapLong  Float @default(0)
  swapShort Float @default(0)

  minVolume Float?
  maxVolume Float?

  trades Trade[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

////////////////////
/// AUDIT
////////////////////

model AuditLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  action   String
  entity   String
  entityId String?
  metadata Json?

  createdAt DateTime @default(now())
}

////////////////////
/// COMPANY & LEGAL
////////////////////

model CompanyStats {
  id              String   @id @default(cuid())
  year            Int
  activeClients   Int      @default(0)
  totalAccounts   Int      @default(0)
  totalTrades     Int      @default(0)
  totalVolume     Decimal  @default(0)
  totalCommission Decimal  @default(0)
  activeAccounts  Int      @default(0)
  updatedAt       DateTime @updatedAt
}

model CommissionPlan {
  id             String   @id @default(cuid())
  name           String
  description    String?
  basePercentage Decimal
  volumeBonus    Decimal  @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model IntroducingBroker {
  id             String   @id @default(cuid())
  name           String   @unique
  email          String   @unique
  commissionPlan String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model PriceSnapshot {
  id        String   @id @default(cuid())
  symbol    String
  price     Decimal
  timestamp DateTime @default(now())

  @@index([symbol])
  @@index([timestamp])
}

model RiskEvent {
  id        String        @id @default(cuid())
  type      RiskEventType
  accountId String?
  severity  String // 'LOW', 'MEDIUM', 'HIGH'
  message   String
  resolved  Boolean       @default(false)

  createdAt  DateTime  @default(now())
  resolvedAt DateTime?

  @@index([accountId])
}

model LegalContent {
  id      String @id @default(cuid())
  type    String // 'TERMS', 'PRIVACY', 'DISCLAIMER'
  title   String
  content String @db.Text
  version Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
